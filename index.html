
        }<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course de Voilier</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #4f9cf9, #2563eb);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
            margin: 5px;
        }
        
        .btn:hover { background: #2563eb; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .btn-green { background: #10b981; }
        .btn-green:hover { background: #059669; }
        .btn-yellow { background: #f59e0b; }
        .btn-yellow:hover { background: #d97706; }
        .btn-red { background: #ef4444; }
        .btn-red:hover { background: #dc2626; }
        .btn-purple { background: #8b5cf6; }
        .btn-purple:hover { background: #7c3aed; }
        .btn-orange { background: #f97316; }
        .btn-orange:hover { background: #ea580c; }
        
        .grid { display: grid; gap: 16px; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }
        
        .text-center { text-align: center; }
        .text-white { color: white; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .font-bold { font-weight: bold; }
        .mb-4 { margin-bottom: 16px; }
        .mb-6 { margin-bottom: 24px; }
        .mt-4 { margin-top: 16px; }
        .p-4 { padding: 16px; }
        .hidden { display: none; }
        
        .stat-card {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        
        .stat-green { background: #ecfdf5; border-color: #10b981; color: #065f46; }
        .stat-yellow { background: #fefbeb; border-color: #f59e0b; color: #92400e; }
        .stat-purple { background: #f5f3ff; border-color: #8b5cf6; color: #581c87; }
        
        .race-track {
            background: linear-gradient(90deg, #bfdbfe 0%, #3b82f6 100%);
            height: 100px;
            border-radius: 8px;
            position: relative;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .boat {
            position: absolute;
            font-size: 24px;
            transition: all 1s ease;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .boat-player { animation: bounce 2s infinite; }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(-50%); }
            40% { transform: translateY(-60%); }
            60% { transform: translateY(-55%); }
        }
        
        .finish-line {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #dc2626;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #d1d5db;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }
        
        .optimum { color: #10b981; font-weight: bold; }
        .not-optimum { color: #ef4444; font-weight: bold; }
        
        .championship-info {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .upgrade-item {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 16px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sponsor-item {
            background: #fdf4ff;
            border: 1px solid #c084fc;
            border-radius: 8px;
            padding: 16px;
            margin: 8px 0;
        }
        
        .race-status {
            background: #10b981;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .event-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #1f2937;
            color: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Menu Principal -->
        <div id="menu" class="screen">
            <h1 class="text-3xl font-bold text-white text-center mb-6">üèÅ Course de Voilier üèÅ</h1>
            
            <!-- Statut de course en cours -->
            <div id="race-status" class="race-status hidden">
                <div class="text-center">
                    <strong>Course en cours !</strong><br>
                    Position: <span id="current-position">1</span>/8 - 
                    Temps restant: <span id="time-remaining">0</span>
                    <button class="btn btn-green" onclick="showScreen('race')">Retour √† la course</button>
                </div>
            </div>
            
            <!-- Stats du joueur -->
            <div class="card">
                <div class="grid grid-3">
                    <div class="stat-card stat-green">
                        <div class="font-bold">Argent</div>
                        <div class="text-2xl" id="player-money">25,000‚Ç¨</div>
                    </div>
                    <div class="stat-card">
                        <div class="font-bold">XP</div>
                        <div class="text-2xl" id="player-xp">0</div>
                    </div>
                    <div class="stat-card stat-purple">
                        <div class="font-bold">Niveau</div>
                        <div class="text-2xl" id="player-level">1</div>
                    </div>
                </div>
            </div>
            
            <!-- Menu principal -->
            <div class="card">
                <div class="grid grid-5">
                    <button class="btn btn-green" onclick="showScreen('race-setup')">
                        üèÅ<br>Course Libre
                    </button>
                    <button class="btn btn-yellow" onclick="showScreen('championships')">
                        üèÜ<br>Championnats
                    </button>
                    <button class="btn btn-orange" onclick="showScreen('shop')">
                        üõí<br>Boutique
                    </button>
                    <button class="btn btn-purple" onclick="showScreen('sponsors')">
                        ü§ù<br>Sponsors
                    </button>
                    <button class="btn" onclick="showScreen('history')">
                        üìä<br>Historique
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Configuration de course -->
        <div id="race-setup" class="screen hidden">
            <button class="btn" onclick="showScreen('menu')">‚Üê Retour</button>
            <div class="card">
                <h2 class="text-2xl font-bold text-center mb-4">Configuration de Course</h2>
                
                <div class="mb-6">
                    <h3 class="font-bold mb-4">Difficult√© des adversaires</h3>
                    <div class="grid grid-3">
                        <button class="btn" id="diff-debutant" onclick="setDifficulty('debutant')">D√©butant</button>
                        <button class="btn" id="diff-intermediaire" onclick="setDifficulty('intermediaire')">Interm√©diaire</button>
                        <button class="btn" id="diff-expert" onclick="setDifficulty('expert')">Expert</button>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="font-bold mb-4">Dur√©e de la course: <span id="duration-display">5 minutes</span></h3>
                    <input type="range" id="duration-slider" class="slider" min="1" max="10080" value="5" onchange="updateDuration()">
                    <div class="grid grid-5 text-center text-sm mt-2">
                        <span>1 min</span>
                        <span>24h</span>
                        <span>48h</span>
                        <span>5 jours</span>
                        <span>7 jours</span>
                    </div>
                </div>
                
                <div class="mb-6">
                    <div class="stat-card stat-yellow text-center">
                        <div class="font-bold">Frais d'inscription</div>
                        <div class="text-xl" id="entry-fee">1,500‚Ç¨</div>
                    </div>
                </div>
                
                <button class="btn btn-green text-xl" style="width: 100%; padding: 16px;" onclick="startRace()" id="start-race-btn">
                    Commencer la Course
                </button>
            </div>
        </div>
        
        <!-- √âcran de course -->
        <div id="race" class="screen hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button class="btn" onclick="showScreen('menu')">‚Üê Menu</button>
                <h2 class="text-2xl font-bold text-white">Course en Direct</h2>
                <div style="width: 80px;"></div>
            </div>
            
            <div class="card">
                <!-- Stats de course -->
                <div class="grid grid-4 mb-6">
                    <div class="stat-card">
                        <div class="font-bold">Position</div>
                        <div class="text-2xl" id="race-position">1/8</div>
                    </div>
                    <div class="stat-card stat-green">
                        <div class="font-bold">Temps Restant</div>
                        <div class="text-xl" id="race-time">5:00</div>
                    </div>
                    <div class="stat-card stat-yellow">
                        <div class="font-bold">M√©t√©o</div>
                        <div id="weather">üåä Normal</div>
                    </div>
                    <div class="stat-card stat-purple">
                        <div class="font-bold">Progr√®s</div>
                        <div class="text-xl" id="race-progress">0%</div>
                    </div>
                </div>
                
                <!-- √âv√©nement en cours -->
                <div id="current-event" class="hidden" style="background: #1f2937; color: white; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center;">
                    <div class="font-bold" id="event-title">üåä √âv√©nement en cours</div>
                    <div id="event-description">Description de l'√©v√©nement</div>
                    <div style="font-size: 0.875rem; margin-top: 8px;">Temps restant: <span id="event-timer">30s</span></div>
                </div>
                
                <!-- Info championnat -->
                <div id="championship-info" class="championship-info hidden">
                    <strong>Championnat en cours</strong> - Course <span id="champ-race-num">1</span>/20 - 
                    Points: <span id="champ-points">0</span>
                </div>
                
                <!-- Condition du bateau -->
                <div class="mb-6">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span class="font-bold">Condition du Bateau: <span id="boat-condition">100</span>%</span>
                        <span id="repair-status" class="optimum">PARFAIT √âTAT</span>
                    </div>
                    <div style="width: 100%; background: #e5e7eb; border-radius: 4px; height: 8px;">
                        <div id="condition-bar" style="width: 100%; background: #10b981; height: 100%; border-radius: 4px; transition: all 0.3s;"></div>
                    </div>
                </div>
                
                <!-- R√©paration (affich√© seulement si n√©cessaire) -->
                <div id="repair-section" class="mb-6 hidden">
                    <div style="background: #fef2f2; border: 2px solid #f87171; border-radius: 8px; padding: 16px;">
                        <div class="font-bold" style="color: #dc2626;">üîß R√âPARATION N√âCESSAIRE</div>
                        <div style="margin: 8px 0;">Cliquez rapidement pour r√©parer !</div>
                        <button id="repair-btn" class="btn btn-red" onclick="performRepair()" style="width: 100%; margin-top: 8px;">
                            R√âPARER (Progr√®s: <span id="repair-progress">0</span>/<span id="repair-total">100</span>)
                        </button>
                    </div>
                </div>
                
                <!-- Checkpoints -->
                <div class="mb-6">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="font-bold">Checkpoints</span>
                        <span id="checkpoint-status">0/3 pass√©s</span>
                    </div>
                    <div id="checkpoints-display" class="mt-2"></div>
                </div>
                <div class="mb-6">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span class="font-bold">R√©glage des Voiles: <span id="sail-value">50</span>%</span>
                        <span id="sail-status" class="optimum">OPTIMUM</span>
                    </div>
                    <input type="range" id="sail-slider" class="slider" min="0" max="100" value="50" 
                           onchange="updateSails()" disabled>
                </div>
                
                <!-- Pilote automatique -->
                <div class="mb-6">
                    <button class="btn btn-green" id="autopilot-btn" onclick="toggleAutopilot()">
                        ü§ñ Pilote Auto: ON
                    </button>
                    <span id="autopilot-efficiency" class="ml-4">Efficacit√©: 80%</span>
                </div>
                
                <!-- Visualisation de la course -->
                <div class="race-track" id="race-track">
                    <div class="finish-line"></div>
                    <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); 
                                color: white; font-weight: bold; font-size: 12px;">ARRIV√âE</div>
                </div>
                
                <!-- Classement -->
                <div>
                    <h3 class="font-bold mb-4">Classement en Direct</h3>
                    <div id="race-ranking"></div>
                </div>
            </div>
        </div>
        
        <!-- Championnats -->
        <div id="championships" class="screen hidden">
            <button class="btn" onclick="showScreen('menu')">‚Üê Retour</button>
            <div class="card">
                <h2 class="text-2xl font-bold text-center mb-4">üèÜ Championnats</h2>
                
                <!-- Championnat en cours -->
                <div id="active-championship" class="championship-info hidden">
                    <h3 class="font-bold">Championnat en cours: <span id="active-champ-name"></span></h3>
                    <div class="grid grid-3 mt-4">
                        <div class="text-center">
                            <div class="font-bold">Course</div>
                            <div class="text-xl" id="champ-current-race">1/20</div>
                        </div>
                        <div class="text-center">
                            <div class="font-bold">Vos Points</div>
                            <div class="text-xl" id="champ-your-points">0</div>
                        </div>
                        <div class="text-center">
                            <div class="font-bold">Position</div>
                            <div class="text-xl" id="champ-your-position">1er</div>
                        </div>
                    </div>
                </div>
                
                <!-- Liste des championnats -->
                <div id="championships-list"></div>
            </div>
        </div>
        
        <!-- Boutique -->
        <div id="shop" class="screen hidden">
            <button class="btn" onclick="showScreen('menu')">‚Üê Retour</button>
            <div class="card">
                <h2 class="text-2xl font-bold text-center mb-4">üõí Boutique</h2>
                <p class="text-center mb-6">Argent disponible: <span id="shop-money">25,000‚Ç¨</span></p>
                
                <h3 class="font-bold mb-4">Am√©liorations du Bateau</h3>
                <div id="boat-upgrades"></div>
                
                <h3 class="font-bold mb-4 mt-6">ü§ñ Pilote Automatique</h3>
                <div id="autopilot-upgrades"></div>
                
                <h3 class="font-bold mb-4 mt-6">üè¢ Multi-Race Manager</h3>
                <div id="manager-upgrades"></div>
            </div>
        </div>
        
        <!-- Sponsors -->
        <div id="sponsors" class="screen hidden">
            <button class="btn" onclick="showScreen('menu')">‚Üê Retour</button>
            <div class="card">
                <h2 class="text-2xl font-bold text-center mb-4">ü§ù Sponsors</h2>
                <div id="sponsors-list"></div>
            </div>
        </div>
        
        <!-- Historique -->
        <div id="history" class="screen hidden">
            <button class="btn" onclick="showScreen('menu')">‚Üê Retour</button>
            <div class="card">
                <h2 class="text-2xl font-bold text-center mb-4">üìä Historique</h2>
                
                <h3 class="font-bold mb-4">Derni√®res Courses</h3>
                <div id="race-history">
                    <p class="text-center" style="color: #6b7280;">Aucune course termin√©e</p>
                </div>
                
                <h3 class="font-bold mb-4 mt-6">Championnats Termin√©s</h3>
                <div id="championship-history">
                    <p class="text-center" style="color: #6b7280;">Aucun championnat termin√©</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let gameData = {
            money: 25000,
            xp: 0,
            level: 1,
            boat: { speed: 10, handling: 10, endurance: 10 },
            autopilot: { level: 1, name: "Basic", efficiency: 0.8 },
            multiRaceManager: { level: 0, maxConcurrentRaces: 1 },
            sponsors: [],
            raceHistory: [],
            championships: [],
            unlockedChampionships: ['amateur'],
            activeRaces: []
        };
        
        let raceState = {
            isRacing: false,
            isAutopilot: true,
            sailTrim: 50,
            position: 1,
            progress: 0,
            competitors: [],
            timeLeft: 0,
            weather: 'normal',
            difficulty: 'debutant',
            duration: 5,
            currentEvent: null,
            eventTimeLeft: 0,
            // Nouvelles fonctionnalit√©s
            boatCondition: 100, // 0-100, affecte la vitesse
            needsRepair: false,
            repairProgress: 0,
            repairNeeded: 100, // Progression n√©cessaire pour r√©parer
            checkpoints: [],
            currentCheckpoint: 0,
            weatherChangeTimer: 0
        };
        
        let championshipState = {
            isActive: false,
            currentRace: 0,
            totalRaces: 20,
            playerPoints: 0,
            standings: [],
            championshipData: null
        };
        
        let raceInterval = null;
        
        // Donn√©es statiques
        const autopilotLevels = [
            { level: 1, name: "Basic", efficiency: 0.8, cost: 0 },
            { level: 2, name: "Avanc√©", efficiency: 0.9, cost: 5000 },
            { level: 3, name: "Expert", efficiency: 0.95, cost: 15000 },
            { level: 4, name: "IA Elite", efficiency: 0.98, cost: 50000 }
        ];
        
        const multiRaceManagerLevels = [
            { level: 0, name: "Aucun", maxRaces: 1, cost: 0 },
            { level: 1, name: "Manager Basique", maxRaces: 2, cost: 10000 },
            { level: 2, name: "Manager Pro", maxRaces: 3, cost: 25000 },
            { level: 3, name: "Manager Elite", maxRaces: 5, cost: 50000 }
        ];
        
        const raceEntryFees = {
            'debutant': 1500,
            'intermediaire': 2000,
            'expert': 3000
        };
        
        const championships = [
            { id: 'amateur', name: 'Championnat Amateur', cost: 0, requirement: 1, difficulty: 'debutant', 
              prize1: 50000, prize2: 25000, prize3: 10000 },
            { id: 'pro', name: 'Championnat Pro', cost: 15000, requirement: 5, difficulty: 'intermediaire',
              prize1: 100000, prize2: 50000, prize3: 25000 },
            { id: 'elite', name: 'Championnat Elite', cost: 50000, requirement: 15, difficulty: 'expert',
              prize1: 250000, prize2: 125000, prize3: 60000 }
        ];
        
        const sponsors = [
            { name: "Marine Pro", bonus: 1000, requirement: 5 },
            { name: "Ocean Master", bonus: 2500, requirement: 10 },
            { name: "Sailing Elite", bonus: 5000, requirement: 20 }
        ];
        
        // Sauvegarde et chargement
        function saveGame() {
            try {
                const saveData = {
                    gameData: gameData,
                    championshipState: championshipState,
                    raceState: raceState
                };
                localStorage.setItem('sailingGame', JSON.stringify(saveData));
            } catch (error) {
                console.warn('Erreur sauvegarde:', error);
            }
        }
        
        function loadGame() {
            try {
                const saved = localStorage.getItem('sailingGame');
                if (saved) {
                    const saveData = JSON.parse(saved);
                    gameData = Object.assign(gameData, saveData.gameData || {});
                    championshipState = Object.assign(championshipState, saveData.championshipState || {});
                    
                    if (saveData.raceState) {
                        raceState = Object.assign(raceState, saveData.raceState);
                        if (raceState.isRacing) {
                            console.log('Course en cours d√©tect√©e, red√©marrage...');
                            startRaceLoop();
                        }
                    }
                }
            } catch (error) {
                console.warn('Erreur chargement:', error);
            }
        }
        
        // Fonctions d'affichage
        function showScreen(screenName) {
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenName).classList.remove('hidden');
            updateDisplay();
        }
        
        function updateDisplay() {
            document.getElementById('player-money').textContent = formatMoney(gameData.money);
            document.getElementById('player-xp').textContent = gameData.xp;
            document.getElementById('player-level').textContent = gameData.level;
            document.getElementById('shop-money').textContent = formatMoney(gameData.money);
            
            updateRaceStatus();
            updateDifficultyButtons();
            updateShop();
            updateSponsors();
            updateChampionships();
            updateHistory();
        }
        
        function updateRaceStatus() {
            const statusDiv = document.getElementById('race-status');
            if (raceState.isRacing) {
                statusDiv.classList.remove('hidden');
                document.getElementById('current-position').textContent = raceState.position;
                document.getElementById('time-remaining').textContent = formatTime(raceState.timeLeft);
            } else {
                statusDiv.classList.add('hidden');
            }
        }
        
        function updateDifficultyButtons() {
            ['debutant', 'intermediaire', 'expert'].forEach(diff => {
                const btn = document.getElementById('diff-' + diff);
                if (raceState.difficulty === diff) {
                    btn.className = 'btn btn-green';
                } else {
                    btn.className = 'btn';
                }
            });
        }
        
        // Configuration de course
        function setDifficulty(difficulty) {
            raceState.difficulty = difficulty;
            updateDifficultyButtons();
            updateDuration();
        }
        
        function updateDuration() {
            const slider = document.getElementById('duration-slider');
            const value = parseInt(slider.value);
            raceState.duration = value;
            
            let displayText;
            if (value < 60) {
                displayText = value + ' minute' + (value > 1 ? 's' : '');
            } else if (value < 1440) {
                const hours = Math.floor(value / 60);
                displayText = hours + ' heure' + (hours > 1 ? 's' : '');
            } else {
                const days = Math.floor(value / 1440);
                displayText = days + ' jour' + (days > 1 ? 's' : '');
            }
            
            document.getElementById('duration-display').textContent = displayText;
            
            const entryFee = raceEntryFees[raceState.difficulty];
            document.getElementById('entry-fee').textContent = formatMoney(entryFee);
        }
        
        // D√©marrage de course
        function startRace() {
            if (raceState.isRacing) return;
            
            const entryFee = raceEntryFees[raceState.difficulty];
            if (gameData.money < entryFee) {
                alert('Argent insuffisant !\\nFrais d inscription: ' + formatMoney(entryFee) + '\\nVotre argent: ' + formatMoney(gameData.money));
                return;
            }
            
            const maxRaces = multiRaceManagerLevels.find(m => m.level === gameData.multiRaceManager.level).maxRaces;
            if (gameData.activeRaces && gameData.activeRaces.length >= maxRaces) {
                alert('Limite de courses simultan√©es atteinte !\\nNiveau Manager: ' + maxRaces + ' course(s) max');
                return;
            }
            
            gameData.money -= entryFee;
            
            raceState.isRacing = true;
            raceState.timeLeft = raceState.duration * 60;
            raceState.progress = 0;
            raceState.position = 1;
            raceState.sailTrim = 50;
            raceState.weather = ['calme', 'normal', 'venteux'][Math.floor(Math.random() * 3)];
            raceState.entryFeePaid = entryFee;
            raceState.events = {
                nextEventTime: Math.random() * raceState.timeLeft,
                hasHadEvent: false
            };
            
            generateCompetitors();
            
            if (!gameData.activeRaces) gameData.activeRaces = [];
            gameData.activeRaces.push({
                id: Date.now(),
                startTime: Date.now(),
                duration: raceState.duration,
                difficulty: raceState.difficulty
            });
            
            showScreen('race');
            startRaceLoop();
            saveGame();
            updateDisplay();
        }
        
        function generateCompetitors() {
            raceState.competitors = [];
            const baseSpeed = raceState.difficulty === 'debutant' ? 8 : 
                             raceState.difficulty === 'intermediaire' ? 12 : 16;
            
            for (let i = 0; i < 7; i++) {
                raceState.competitors.push({
                    id: i,
                    name: 'Adversaire ' + (i + 1),
                    speed: baseSpeed + Math.random() * 4,
                    progress: 0
                });
            }
        }
        
        function startRaceLoop() {
            if (raceInterval) clearInterval(raceInterval);
            
            raceInterval = setInterval(function() {
                if (!raceState.isRacing) {
                    clearInterval(raceInterval);
                    raceInterval = null;
                    return;
                }
                
                updateRaceStep();
                updateRaceDisplay();
                saveGame();
                
                if (raceState.timeLeft <= 0 || raceState.progress >= 100) {
                    finishRace();
                }
            }, 1000);
        }
        
        function updateRaceStep() {
            raceState.timeLeft--;
            
            // √âv√©nements al√©atoires
            if (!raceState.events.hasHadEvent && raceState.timeLeft <= raceState.events.nextEventTime) {
                triggerRandomEvent();
                raceState.events.hasHadEvent = true;
            }
            
            // Pilote automatique
            if (raceState.isAutopilot) {
                const autopilot = autopilotLevels.find(a => a.level === gameData.autopilot.level);
                let targetTrim = 50;
                
                if (raceState.weather === 'calme') targetTrim = 40;
                else if (raceState.weather === 'venteux') targetTrim = 60;
                
                if (raceState.currentEvent === 'tempete') targetTrim = 30;
                else if (raceState.currentEvent === 'vent_favorable') targetTrim = 70;
                
                raceState.sailTrim = targetTrim;
            }
            
            // Calcul progression joueur
            const weatherMultiplier = raceState.weather === 'calme' ? 0.8 : 
                                     raceState.weather === 'venteux' ? 1.2 : 1.0;
            
            let eventMultiplier = 1.0;
            if (raceState.currentEvent === 'tempete') eventMultiplier = 0.7;
            else if (raceState.currentEvent === 'vent_favorable') eventMultiplier = 1.3;
            else if (raceState.currentEvent === 'reparation') eventMultiplier = 0.9;
            
            let trimEfficiency = 1 - Math.abs(50 - raceState.sailTrim) / 100;
            if (raceState.isAutopilot) {
                const autopilot = autopilotLevels.find(a => a.level === gameData.autopilot.level);
                trimEfficiency = Math.max(trimEfficiency, autopilot.efficiency);
            }
            
            const baseProgress = 100 / (raceState.duration * 60);
            const playerSpeed = (gameData.boat.speed / 10) * weatherMultiplier * trimEfficiency * eventMultiplier;
            raceState.progress = Math.min(raceState.progress + baseProgress * playerSpeed, 100);
            
            // Progression adversaires
            raceState.competitors.forEach(function(comp) {
                const compEventMultiplier = 0.8 + Math.random() * 0.4;
                const compSpeed = (comp.speed / 10) * (0.9 + Math.random() * 0.2) * compEventMultiplier;
                comp.progress = Math.min(comp.progress + baseProgress * compSpeed, 100);
            });
            
            // Calcul position
            const allRacers = [{ progress: raceState.progress, isPlayer: true }].concat(raceState.competitors);
            allRacers.sort(function(a, b) { return b.progress - a.progress; });
            raceState.position = allRacers.findIndex(function(r) { return r.isPlayer; }) + 1;
        }
        
        function triggerRandomEvent() {
            const events = [
                { name: 'tempete', title: '‚õàÔ∏è Temp√™te !', description: 'Une temp√™te ralentit votre progression', duration: 30 },
                { name: 'vent_favorable', title: 'üí® Vent favorable !', description: 'Un vent favorable acc√©l√®re votre bateau', duration: 45 },
                { name: 'reparation', title: 'üîß Probl√®me technique', description: 'Probl√®me mineur qui ralentit l√©g√®rement', duration: 20 },
                { name: 'dauphin', title: 'üê¨ Dauphins !', description: 'Des dauphins vous accompagnent (boost moral)', duration: 15 }
            ];
            
            const event = events[Math.floor(Math.random() * events.length)];
            raceState.currentEvent = event.name;
            raceState.eventTimeLeft = event.duration;
            
            showEventNotification(event.title, event.description);
        }
        
        function showEventNotification(title, description) {
            const notification = document.createElement('div');
            notification.className = 'event-notification';
            notification.innerHTML = '<div style="font-weight: bold; margin-bottom: 8px;">' + title + '</div><div>' + description + '</div>';
            document.body.appendChild(notification);
            
            setTimeout(function() {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        function updateRaceDisplay() {
            document.getElementById('race-position').textContent = raceState.position + '/8';
            document.getElementById('race-time').textContent = formatTime(raceState.timeLeft);
            document.getElementById('race-progress').textContent = Math.round(raceState.progress) + '%';
            document.getElementById('sail-value').textContent = raceState.sailTrim;
            
            // Condition du bateau
            document.getElementById('boat-condition').textContent = Math.round(raceState.boatCondition);
            const conditionBar = document.getElementById('condition-bar');
            conditionBar.style.width = raceState.boatCondition + '%';
            
            if (raceState.boatCondition >= 80) {
                conditionBar.style.background = '#10b981'; // Vert
                document.getElementById('repair-status').textContent = 'PARFAIT √âTAT';
                document.getElementById('repair-status').className = 'optimum';
            } else if (raceState.boatCondition >= 50) {
                conditionBar.style.background = '#f59e0b'; // Orange
                document.getElementById('repair-status').textContent = '√âTAT MOYEN';
                document.getElementById('repair-status').className = 'not-optimum';
            } else {
                conditionBar.style.background = '#ef4444'; // Rouge
                document.getElementById('repair-status').textContent = 'MAUVAIS √âTAT';
                document.getElementById('repair-status').className = 'not-optimum';
            }
            
            // Section r√©paration
            const repairSection = document.getElementById('repair-section');
            if (raceState.needsRepair) {
                repairSection.classList.remove('hidden');
                document.getElementById('repair-progress').textContent = Math.round(raceState.repairProgress);
                document.getElementById('repair-total').textContent = Math.round(raceState.repairNeeded);
            } else {
                repairSection.classList.add('hidden');
            }
            
            // Checkpoints
            const checkpointStatus = document.getElementById('checkpoint-status');
            checkpointStatus.textContent = raceState.currentCheckpoint + '/' + raceState.checkpoints.length + ' pass√©s';
            
            const checkpointsDisplay = document.getElementById('checkpoints-display');
            let checkpointHtml = '';
            raceState.checkpoints.forEach(function(checkpoint, index) {
                const status = checkpoint.passed ? '‚úÖ' : (raceState.progress >= checkpoint.position - 5 ? 'üü°' : '‚ö™');
                const color = checkpoint.passed ? '#10b981' : (raceState.progress >= checkpoint.position - 5 ? '#f59e0b' : '#9ca3af');
                checkpointHtml += '<span style="margin-right: 8px; color: ' + color + '; font-weight: bold;">' + status + ' ' + checkpoint.name + ' (' + checkpoint.position + '%)</span>';
            });
            checkpointsDisplay.innerHTML = checkpointHtml;
            
            // M√©t√©o
            const weatherIcons = { calme: 'üò¥', normal: 'üåä', venteux: 'üí®' };
            document.getElementById('weather').textContent = 
                weatherIcons[raceState.weather] + ' ' + raceState.weather.charAt(0).toUpperCase() + raceState.weather.slice(1);
            
            // √âv√©nement en cours
            const eventDiv = document.getElementById('current-event');
            if (raceState.currentEvent && raceState.eventTimeLeft > 0) {
                eventDiv.classList.remove('hidden');
                const events = {
                    'tempete': { title: '‚õàÔ∏è Temp√™te !', desc: 'Vitesse r√©duite' },
                    'vent_favorable': { title: 'üí® Vent favorable !', desc: 'Vitesse augment√©e' },
                    'reparation': { title: 'üîß Probl√®me technique', desc: 'L√©ger ralentissement' },
                    'dauphin': { title: 'üê¨ Dauphins !', desc: 'Boost de moral' }
                };
                const event = events[raceState.currentEvent];
                document.getElementById('event-title').textContent = event.title;
                document.getElementById('event-description').textContent = event.desc;
                document.getElementById('event-timer').textContent = raceState.eventTimeLeft + 's';
                raceState.eventTimeLeft--;
                
                if (raceState.eventTimeLeft <= 0) {
                    raceState.currentEvent = null;
                    eventDiv.classList.add('hidden');
                }
            } else {
                eventDiv.classList.add('hidden');
            }
            
            // Statut des voiles
            const sailStatus = document.getElementById('sail-status');
            if (Math.abs(50 - raceState.sailTrim) < 10) {
                sailStatus.textContent = 'OPTIMUM';
                sailStatus.className = 'optimum';
            } else {
                sailStatus.textContent = '√Ä AJUSTER';
                sailStatus.className = 'not-optimum';
            }
            
            document.getElementById('sail-slider').value = raceState.sailTrim;
            updateRaceVisualization();
            updateRanking();
        }
        
        function updateRaceVisualization() {
            const track = document.getElementById('race-track');
            const existingBoats = track.querySelectorAll('.boat');
            existingBoats.forEach(function(boat) { boat.remove(); });
            
            // Supprimer les anciennes bou√©es
            const existingBuoys = track.querySelectorAll('.checkpoint-buoy');
            existingBuoys.forEach(function(buoy) { buoy.remove(); });
            
            // Ajouter les bou√©es (checkpoints)
            raceState.checkpoints.forEach(function(checkpoint) {
                const buoy = document.createElement('div');
                buoy.className = 'checkpoint-buoy';
                buoy.innerHTML = checkpoint.passed ? '‚úÖ' : '‚öì';
                buoy.style.position = 'absolute';
                buoy.style.left = (checkpoint.position * 0.9) + '%'; // 90% pour rester dans les limites
                buoy.style.top = '10px';
                buoy.style.fontSize = '16px';
                buoy.style.transform = 'translateX(-50%)';
                buoy.style.zIndex = '10';
                track.appendChild(buoy);
            });
            
            // Bateau du joueur
            const playerBoat = document.createElement('div');
            playerBoat.className = 'boat boat-player';
            playerBoat.innerHTML = '‚õµ';
            playerBoat.style.left = Math.min(raceState.progress, 95) + '%';
            playerBoat.style.top = '20px';
            track.appendChild(playerBoat);
            
            // Bateaux adversaires
            raceState.competitors.forEach(function(comp, index) {
                const boat = document.createElement('div');
                boat.className = 'boat';
                boat.innerHTML = 'üö§';
                boat.style.left = Math.min(comp.progress, 95) + '%';
                boat.style.top = (40 + index * 8) + 'px';
                track.appendChild(boat);
            });
        }
        
        function finishRace() {
            // V√©rifier que tous les checkpoints sont pass√©s
            const allCheckpointsPassed = raceState.checkpoints.every(function(checkpoint) {
                return checkpoint.passed;
            });
            
            if (!allCheckpointsPassed && raceState.progress >= 100) {
                // P√©nalit√© pour avoir rat√© des checkpoints
                raceState.progress = 95; // R√©duire le progr√®s
                showEventNotification('‚ùå P√âNALIT√â !', 'Vous avez rat√© des bou√©es ! Retournez les passer !');
                return; // Ne pas finir la course
            }
            
            raceState.isRacing = false;
            if (raceInterval) {
                clearInterval(raceInterval);
                raceInterval = null;
            }
            
            const position = raceState.position;
            const isWinner = raceState.progress >= 100 && position === 1 && allCheckpointsPassed;
            
            let prize = 0;
            let xp = 0;
            
            // Bonus pour l'√©tat du bateau
            const conditionBonus = raceState.boatCondition >= 80 ? 1.2 : raceState.boatCondition >= 50 ? 1.0 : 0.8;
            
            if (championshipState.isActive) {
                const points = [25, 18, 15, 12, 10, 8, 6, 4, 2, 1][position - 1] || 0;
                championshipState.playerPoints += points;
                championshipState.currentRace++;
                
                prize = Math.max(1000, 500 * (9 - position)) * conditionBonus;
                xp = Math.max(25, 100 - position * 10);
                
                if (championshipState.currentRace > 20) {
                    finishChampionship();
                }
            } else {
                prize = (isWinner ? 8000 : position <= 3 ? 3000 : 1000) * conditionBonus;
                xp = isWinner ? 150 : position <= 3 ? 75 : 25;
            }
            
            gameData.money += Math.round(prize);
            gameData.xp += xp;
            gameData.level = Math.floor(gameData.xp / 100) + 1;
            
            gameData.raceHistory.push({
                date: new Date().toLocaleDateString(),
                position: position,
                prize: Math.round(prize),
                xp: xp,
                difficulty: raceState.difficulty,
                duration: raceState.duration,
                type: championshipState.isActive ? 'Championnat' : 'Course libre',
                boatCondition: Math.round(raceState.boatCondition),
                checkpointsPassed: raceState.currentCheckpoint + '/' + raceState.checkpoints.length
            });
            
            if (gameData.activeRaces) {
                gameData.activeRaces = gameData.activeRaces.filter(function(race) {
                    return Date.now() - race.startTime < race.duration * 60 * 1000;
                });
            }
            
            saveGame();
            updateDisplay();
            
            let resultMessage = 'Course termin√©e !\\n';
            resultMessage += 'Position: ' + position + '/8\\n';
            resultMessage += 'Gains: ' + formatMoney(Math.round(prize)) + ' + ' + xp + ' XP\\n';
            resultMessage += '√âtat du bateau: ' + Math.round(raceState.boatCondition) + '%\\n';
            resultMessage += 'Checkpoints: ' + raceState.currentCheckpoint + '/' + raceState.checkpoints.length;
            if (conditionBonus !== 1.0) {
                resultMessage += '\\nBonus condition: x' + conditionBonus.toFixed(1);
            }
            
            alert(resultMessage);
        }
        
        function updateRanking() {
            const rankingDiv = document.getElementById('race-ranking');
            const allRacers = [{ name: 'Vous', progress: raceState.progress, isPlayer: true }].concat(raceState.competitors);
            allRacers.sort(function(a, b) { return b.progress - a.progress; });
            
            let html = '';
            allRacers.forEach(function(racer, index) {
                const position = index + 1;
                const medal = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : position === 3 ? 'ü•â' : position;
                const playerClass = racer.isPlayer ? 'font-bold' : '';
                const bgColor = racer.isPlayer ? 'background: #dbeafe;' : 'background: #f9fafb;';
                
                html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 4px 0; border-radius: 6px; ' + bgColor + '"><span class="' + playerClass + '">' + medal + ' ' + racer.name + '</span><span class="' + playerClass + '">' + Math.round(racer.progress) + '%</span></div>';
            });
            rankingDiv.innerHTML = html;
        }
        
        function toggleAutopilot() {
            raceState.isAutopilot = !raceState.isAutopilot;
            const btn = document.getElementById('autopilot-btn');
            const slider = document.getElementById('sail-slider');
            
            if (raceState.isAutopilot) {
                btn.textContent = 'ü§ñ Pilote Auto: ON';
                btn.className = 'btn btn-green';
                slider.disabled = true;
            } else {
                btn.textContent = 'ü§ñ Pilote Auto: OFF';
                btn.className = 'btn';
                slider.disabled = false;
            }
            
            const autopilot = autopilotLevels.find(function(a) { return a.level === gameData.autopilot.level; });
            document.getElementById('autopilot-efficiency').textContent = 'Efficacit√©: ' + Math.round(autopilot.efficiency * 100) + '%';
        }
        
        function updateSails() {
            if (!raceState.isAutopilot) {
                raceState.sailTrim = parseInt(document.getElementById('sail-slider').value);
                document.getElementById('sail-value').textContent = raceState.sailTrim;
            }
        }
        
        function finishRace() {
            // V√©rifier que tous les checkpoints sont pass√©s
            const allCheckpointsPassed = raceState.checkpoints.every(function(checkpoint) {
                return checkpoint.passed;
            });
            
            if (!allCheckpointsPassed && raceState.progress >= 100) {
                // P√©nalit√© pour avoir rat√© des checkpoints
                raceState.progress = 95; // R√©duire le progr√®s
                showEventNotification('‚ùå P√âNALIT√â !', 'Vous avez rat√© des bou√©es ! Retournez les passer !');
                return; // Ne pas finir la course
            }
            
            raceState.isRacing = false;
            if (raceInterval) {
                clearInterval(raceInterval);
                raceInterval = null;
            }
            
            const position = raceState.position;
            const isWinner = raceState.progress >= 100 && position === 1 && allCheckpointsPassed;
            
            let prize = 0;
            let xp = 0;
            
            // Bonus pour l'√©tat du bateau
            const conditionBonus = raceState.boatCondition >= 80 ? 1.2 : raceState.boatCondition >= 50 ? 1.0 : 0.8;
            
            if (championshipState.isActive) {
                const points = [25, 18, 15, 12, 10, 8, 6, 4, 2, 1][position - 1] || 0;
                championshipState.playerPoints += points;
                championshipState.currentRace++;
                
                prize = Math.max(1000, 500 * (9 - position)) * conditionBonus;
                xp = Math.max(25, 100 - position * 10);
                
                if (championshipState.currentRace > 20) {
                    finishChampionship();
                }
            } else {
                prize = (isWinner ? 8000 : position <= 3 ? 3000 : 1000) * conditionBonus;
                xp = isWinner ? 150 : position <= 3 ? 75 : 25;
            }
            
            gameData.money += Math.round(prize);
            gameData.xp += xp;
            gameData.level = Math.floor(gameData.xp / 100) + 1;
            
            gameData.raceHistory.push({
                date: new Date().toLocaleDateString(),
                position: position,
                prize: Math.round(prize),
                xp: xp,
                difficulty: raceState.difficulty,
                duration: raceState.duration,
                type: championshipState.isActive ? 'Championnat' : 'Course libre',
                boatCondition: Math.round(raceState.boatCondition),
                checkpointsPassed: raceState.currentCheckpoint + '/' + raceState.checkpoints.length
            });
            
            if (gameData.activeRaces) {
                gameData.activeRaces = gameData.activeRaces.filter(function(race) {
                    return Date.now() - race.startTime < race.duration * 60 * 1000;
                });
            }
            
            saveGame();
            updateDisplay();
            
            let resultMessage = 'Course termin√©e !\\n';
            resultMessage += 'Position: ' + position + '/8\\n';
            resultMessage += 'Gains: ' + formatMoney(Math.round(prize)) + ' + ' + xp + ' XP\\n';
            resultMessage += '√âtat du bateau: ' + Math.round(raceState.boatCondition) + '%\\n';
            resultMessage += 'Checkpoints: ' + raceState.currentCheckpoint + '/' + raceState.checkpoints.length;
            if (conditionBonus !== 1.0) {
                resultMessage += '\\nBonus condition: x' + conditionBonus.toFixed(1);
            }
            
            alert(resultMessage);
        }
        
        function finishChampionship() {
            const finalPosition = 1;
            let championshipPrize = 0;
            
            if (finalPosition === 1) championshipPrize = championshipState.championshipData.prize1;
            else if (finalPosition === 2) championshipPrize = championshipState.championshipData.prize2;
            else if (finalPosition === 3) championshipPrize = championshipState.championshipData.prize3;
            
            gameData.money += championshipPrize;
            gameData.championships.push({
                name: championshipState.championshipData.name,
                date: new Date().toLocaleDateString(),
                position: finalPosition,
                points: championshipState.playerPoints,
                prize: championshipPrize
            });
            
            championshipState.isActive = false;
            championshipState.currentRace = 0;
            championshipState.playerPoints = 0;
            
            alert('Championnat termin√© !\\nPosition finale: ' + finalPosition + '\\nPrix: ' + formatMoney(championshipPrize));
        }
        
        // Boutique
        function updateShop() {
            const boatUpgrades = document.getElementById('boat-upgrades');
            const upgrades = [
                { stat: 'speed', name: 'Vitesse', current: gameData.boat.speed, cost: 1000 },
                { stat: 'handling', name: 'Maniabilit√©', current: gameData.boat.handling, cost: 1200 },
                { stat: 'endurance', name: 'Endurance', current: gameData.boat.endurance, cost: 800 }
            ];
            
            let html = '';
            upgrades.forEach(function(upgrade) {
                const canAfford = gameData.money >= upgrade.cost;
                const btnClass = canAfford ? 'btn btn-green' : 'btn';
                const disabled = canAfford ? '' : 'disabled';
                
                html += '<div class="upgrade-item"><div><div class="font-bold">' + upgrade.name + '</div><div>Niveau actuel: ' + upgrade.current + '</div><div style="color: #10b981; font-weight: bold;">' + formatMoney(upgrade.cost) + '</div></div><button class="' + btnClass + '" onclick="upgradeBoat(\'' + upgrade.stat + '\', ' + upgrade.cost + ')" ' + disabled + '>Am√©liorer</button></div>';
            });
            boatUpgrades.innerHTML = html;
            
            // Pilote automatique
            const autopilotDiv = document.getElementById('autopilot-upgrades');
            const currentLevel = gameData.autopilot.level;
            const currentAutopilot = autopilotLevels.find(function(a) { return a.level === currentLevel; });
            
            let autopilotHtml = '<div class="upgrade-item"><div><div class="font-bold">Niveau Actuel: ' + currentAutopilot.name + '</div><div>Efficacit√©: ' + Math.round(currentAutopilot.efficiency * 100) + '%</div></div><div style="font-size: 24px;">ü§ñ</div></div>';
            
            if (currentLevel < 4) {
                const nextLevel = autopilotLevels.find(function(a) { return a.level === currentLevel + 1; });
                const canAfford = gameData.money >= nextLevel.cost;
                const btnClass = canAfford ? 'btn btn-green' : 'btn';
                const disabled = canAfford ? '' : 'disabled';
                
                autopilotHtml += '<div class="upgrade-item"><div><div class="font-bold">Prochaine am√©lioration: ' + nextLevel.name + '</div><div>Efficacit√©: ' + Math.round(nextLevel.efficiency * 100) + '%</div><div style="color: #10b981; font-weight: bold;">' + formatMoney(nextLevel.cost) + '</div></div><button class="' + btnClass + '" onclick="upgradeAutopilot(' + nextLevel.cost + ', ' + nextLevel.level + ')" ' + disabled + '>Am√©liorer</button></div>';
            } else {
                autopilotHtml += '<div class="upgrade-item" style="background: #fef3c7;"><div class="font-bold text-center">üèÜ NIVEAU MAXIMUM ATTEINT !</div></div>';
            }
            
            autopilotDiv.innerHTML = autopilotHtml;
            
            // Multi-Race Manager
            const managerDiv = document.getElementById('manager-upgrades');
            const currentManagerLevel = gameData.multiRaceManager.level;
            const currentManager = multiRaceManagerLevels.find(function(m) { return m.level === currentManagerLevel; });
            
            let managerHtml = '<div class="upgrade-item"><div><div class="font-bold">Niveau Actuel: ' + currentManager.name + '</div><div>Courses simultan√©es: ' + currentManager.maxRaces + '</div></div><div style="font-size: 24px;">üè¢</div></div>';
            
            if (currentManagerLevel < 3) {
                const nextLevel = multiRaceManagerLevels.find(function(m) { return m.level === currentManagerLevel + 1; });
                const canAfford = gameData.money >= nextLevel.cost;
                const btnClass = canAfford ? 'btn btn-green' : 'btn';
                const disabled = canAfford ? '' : 'disabled';
                
                managerHtml += '<div class="upgrade-item"><div><div class="font-bold">Prochaine am√©lioration: ' + nextLevel.name + '</div><div>Courses simultan√©es: ' + nextLevel.maxRaces + '</div><div style="color: #10b981; font-weight: bold;">' + formatMoney(nextLevel.cost) + '</div></div><button class="' + btnClass + '" onclick="upgradeManager(' + nextLevel.cost + ', ' + nextLevel.level + ')" ' + disabled + '>Am√©liorer</button></div>';
            } else {
                managerHtml += '<div class="upgrade-item" style="background: #fef3c7;"><div class="font-bold text-center">üèÜ NIVEAU MAXIMUM ATTEINT !</div></div>';
            }
            
            managerDiv.innerHTML = managerHtml;
        }
        
        function upgradeBoat(stat, cost) {
            if (gameData.money >= cost) {
                gameData.money -= cost;
                gameData.boat[stat]++;
                saveGame();
                updateDisplay();
            }
        }
        
        function upgradeAutopilot(cost, newLevel) {
            if (gameData.money >= cost) {
                gameData.money -= cost;
                const newAutopilot = autopilotLevels.find(function(a) { return a.level === newLevel; });
                gameData.autopilot = {
                    level: newLevel,
                    name: newAutopilot.name,
                    efficiency: newAutopilot.efficiency
                };
                saveGame();
                updateDisplay();
            }
        }
        
        function upgradeManager(cost, newLevel) {
            if (gameData.money >= cost) {
                gameData.money -= cost;
                const newManager = multiRaceManagerLevels.find(function(m) { return m.level === newLevel; });
                gameData.multiRaceManager = {
                    level: newLevel,
                    maxConcurrentRaces: newManager.maxRaces
                };
                saveGame();
                updateDisplay();
                alert('Manager am√©lior√© !\\nVous pouvez maintenant g√©rer ' + newManager.maxRaces + ' courses simultan√©ment !');
            }
        }
        
        // Sponsors
        function updateSponsors() {
            const sponsorsDiv = document.getElementById('sponsors-list');
            let html = '';
            
            sponsors.forEach(function(sponsor) {
                const hasRequirement = gameData.level >= sponsor.requirement;
                const hasContract = gameData.sponsors.includes(sponsor.name);
                
                let statusHtml = '';
                if (hasContract) {
                    statusHtml = '<span class="btn btn-green" style="cursor: default;">Contrat Actif</span>';
                } else if (hasRequirement) {
                    statusHtml = '<button class="btn btn-purple" onclick="signSponsor(\'' + sponsor.name + '\', ' + sponsor.bonus + ')">Signer le Contrat</button>';
                } else {
                    statusHtml = '<span class="btn" style="cursor: default;">Niveau Insuffisant</span>';
                }
                
                html += '<div class="sponsor-item"><div style="display: flex; justify-content: space-between; align-items: center;"><div><div class="font-bold text-lg">' + sponsor.name + '</div><div>Bonus: ' + formatMoney(sponsor.bonus) + '</div><div>Niveau requis: ' + sponsor.requirement + '</div></div><div>' + statusHtml + '</div></div></div>';
            });
            
            sponsorsDiv.innerHTML = html;
        }
        
        function signSponsor(name, bonus) {
            gameData.money += bonus;
            gameData.sponsors.push(name);
            saveGame();
            updateDisplay();
            alert('Contrat sign√© avec ' + name + ' !\\nBonus re√ßu: ' + formatMoney(bonus));
        }
        
        // Championnats
        function updateChampionships() {
            const champDiv = document.getElementById('championships-list');
            
            const activeDiv = document.getElementById('active-championship');
            if (championshipState.isActive) {
                activeDiv.classList.remove('hidden');
                document.getElementById('active-champ-name').textContent = championshipState.championshipData.name;
                document.getElementById('champ-current-race').textContent = championshipState.currentRace + '/20';
                document.getElementById('champ-your-points').textContent = championshipState.playerPoints;
                document.getElementById('champ-your-position').textContent = '1er';
            } else {
                activeDiv.classList.add('hidden');
            }
            
            let html = '';
            championships.forEach(function(champ) {
                const isUnlocked = gameData.unlockedChampionships.includes(champ.id);
                const canUnlock = gameData.level >= champ.requirement && gameData.money >= champ.cost;
                
                let actionHtml = '';
                if (!isUnlocked && champ.cost > 0) {
                    const btnClass = canUnlock ? 'btn btn-yellow' : 'btn';
                    const disabled = canUnlock ? '' : 'disabled';
                    actionHtml = '<button class="' + btnClass + '" onclick="unlockChampionship(\'' + champ.id + '\', ' + champ.cost + ')" ' + disabled + '>D√©verrouiller (' + formatMoney(champ.cost) + ')</button>';
                } else if (isUnlocked && !championshipState.isActive) {
                    actionHtml = '<div><select id="champ-duration-' + champ.id + '"><option value="5">5 minutes</option><option value="15">15 minutes</option><option value="60">1 heure</option><option value="1440">24 heures</option><option value="2880">48 heures</option><option value="7200">5 jours</option><option value="10080">7 jours</option></select><button class="btn btn-green" onclick="startChampionship(\'' + champ.id + '\')">Commencer</button></div>';
                } else if (championshipState.isActive) {
                    actionHtml = '<span class="btn" style="cursor: default;">Championnat en cours</span>';
                } else {
                    actionHtml = '<span class="btn btn-green" style="cursor: default;">D√©verrouill√©</span>';
                }
                
                html += '<div class="upgrade-item"><div><div class="font-bold text-lg">' + champ.name + '</div><div>Difficult√©: ' + champ.difficulty + '</div><div>Niveau requis: ' + champ.requirement + '</div><div style="color: #f59e0b; font-weight: bold;">ü•á ' + formatMoney(champ.prize1) + ' | ü•à ' + formatMoney(champ.prize2) + ' | ü•â ' + formatMoney(champ.prize3) + '</div></div><div>' + actionHtml + '</div></div>';
            });
            
            champDiv.innerHTML = html;
        }
        
        function unlockChampionship(champId, cost) {
            if (gameData.money >= cost) {
                gameData.money -= cost;
                gameData.unlockedChampionships.push(champId);
                saveGame();
                updateDisplay();
                alert('Championnat d√©verrouill√© !');
            }
        }
        
        function startChampionship(champId) {
            const championship = championships.find(function(c) { return c.id === champId; });
            const durationSelect = document.getElementById('champ-duration-' + champId);
            const duration = parseInt(durationSelect.value);
            
            championshipState.isActive = true;
            championshipState.currentRace = 1;
            championshipState.playerPoints = 0;
            championshipState.championshipData = championship;
            
            raceState.difficulty = championship.difficulty;
            raceState.duration = duration;
            
            saveGame();
            alert('Championnat ' + championship.name + ' commenc√© !\\n20 courses vous attendent.');
            updateDisplay();
        }
        
        // Historique
        function updateHistory() {
            const raceHistoryDiv = document.getElementById('race-history');
            const champHistoryDiv = document.getElementById('championship-history');
            
            if (gameData.raceHistory.length === 0) {
                raceHistoryDiv.innerHTML = '<p class="text-center" style="color: #6b7280;">Aucune course termin√©e</p>';
            } else {
                let html = '';
                gameData.raceHistory.slice(-10).reverse().forEach(function(race) {
                    const medal = race.position === 1 ? 'ü•á' : race.position === 2 ? 'ü•à' : race.position === 3 ? 'ü•â' : race.position + 'e';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; background: #f9fafb; padding: 12px; margin: 8px 0; border-radius: 6px;"><div><div class="font-bold">' + race.date + ' - ' + race.type + '</div><div>Difficult√©: ' + race.difficulty + ' | Dur√©e: ' + race.duration + ' min</div></div><div style="text-align: right;"><div class="font-bold">' + medal + '</div><div style="color: #10b981;">+' + formatMoney(race.prize) + '</div><div style="color: #3b82f6;">+' + race.xp + ' XP</div></div></div>';
                });
                raceHistoryDiv.innerHTML = html;
            }
            
            if (gameData.championships.length === 0) {
                champHistoryDiv.innerHTML = '<p class="text-center" style="color: #6b7280;">Aucun championnat termin√©</p>';
            } else {
                let html = '';
                gameData.championships.forEach(function(champ) {
                    const medal = champ.position === 1 ? 'üèÜ' : champ.position === 2 ? 'ü•à' : champ.position === 3 ? 'ü•â' : champ.position + 'e';
                    html += '<div style="display: flex; justify-content: space-between; align-items: center; background: #fef3c7; padding: 12px; margin: 8px 0; border-radius: 6px;"><div><div class="font-bold">' + champ.name + '</div><div>' + champ.date + '</div></div><div style="text-align: right;"><div class="font-bold">' + medal + '</div><div style="color: #3b82f6;">' + champ.points + ' pts</div><div style="color: #10b981;">+' + formatMoney(champ.prize) + '</div></div></div>';
                });
                champHistoryDiv.innerHTML = html;
            }
        }
        
        // Fonctions utilitaires
        function formatMoney(amount) {
            return amount.toLocaleString() + '‚Ç¨';
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return mins + ':' + secs.toString().padStart(2, '0');
        }
        
        // Initialisation
        function initGame() {
            loadGame();
            updateDisplay();
            updateDuration();
            
            if (raceState.isRacing) {
                showScreen('race');
                console.log('Course restaur√©e !');
            } else {
                showScreen('menu');
            }
        }
        
        window.addEventListener('load', initGame);
    </script>
</body>
</html>